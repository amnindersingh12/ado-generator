<%# app/views/records/show.html.erb %>

<div class="container mt-4">
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="shadow-sm rounded">
        <% if @record.photo.attached? %>
          <%= enlargeable_image_tag(@record.photo, thumb_size: "100%", label: "Main Photo") %>
        <% else %>
          <div class="alert alert-secondary text-center rounded-0">No face photo attached.</div>
        <% end %>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column justify-content-between">
          <div>
            <h3 class="card-title mb-3 fw-semibold text-primary">
              <%= @record.name.presence || "Unnamed Record" %>
              <% if @record.age %>
                <span class="badge bg-primary ms-2 rounded-pill"><%= pluralize(@record.age, "year") %> old</span>
              <% end %>
            </h3>
            <ul class="list-group list-group-flush mb-3">
              <li class="list-group-item">
                <strong class="text-muted">Email:</strong> <%= @record.email.presence || "<span class='text-muted'>Unknown</span>".html_safe %>
              </li>
              <li class="list-group-item">
                <strong class="text-muted">Father's Name:</strong> <%= @record.father_name.presence || "<span class='text-muted'>N/A</span>".html_safe %>
              </li>
              <li class="list-group-item">
                <strong class="text-muted">Contact Number:</strong> <%= @record.contact_number.presence || "<span class='text-muted'>N/A</span>".html_safe %>
              </li>
              <li class="list-group-item">
                <strong class="text-muted">Address:</strong>
                <%= [
                  @record.address.presence,
                  @record.city.presence,
                  @record.state.presence,
                  @record.pincode.presence
                ].compact.join(', ').presence || "<span class='text-muted'>N/A</span>".html_safe %>
              </li>
              <li class="list-group-item">
                <strong class="text-muted">Created By:</strong> <%= @record.user.email.presence || "<span class='text-muted'>Unknown</span>".html_safe %>
              </li>
              <li class="list-group-item">
                <strong class="text-muted">Govt. ID:</strong> <%= @record.government_id_number.presence || "<span class='text-muted'>N/A</span>".html_safe %>
              </li>
              <li class="list-group-item">
                <strong class="text-muted">Govt. ID Photo:</strong><br>
                <% if @record.government_id_photo.attached? %>
                  <%= enlargeable_image_tag(@record.government_id_photo, thumb_size: '120px', label: 'Govt. ID Photo') %>
                <% else %>
                  <span class="text-muted">No government ID photo attached.</span>
                <% end %>
              </li>
            </ul>

            <%# Host/Guest Display Section %>
            <h5 class="mt-4 mb-3 fw-semibold text-primary">Relationship Status</h5>
            <div class="border p-3 rounded bg-light">
              <% if @record.is_guest? %>
                <p class="mb-2">This is a **Guest** record.</p>
                <% if @record.host.present? %>
                  <div class="alert alert-info d-flex align-items-center py-2 px-3 mb-0">
                    <i class="bi bi-person-fill-up me-2 fs-5"></i>
                    <strong>Host:</strong> <%= link_to @record.host.name, record_path(@record.host), class: "alert-link" %> (Contact: <%= @record.host.contact_number %>)
                  </div>
                <% else %>
                  <div class="alert alert-warning py-2 px-3 mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> This guest record is not currently associated with a host.
                  </div>
                <% end %>
              <% elsif @record.guests.any? %>
                <p class="mb-2">This record is a **Host** for the following guests:</p>
                <ul class="list-group list-group-flush mb-0 border rounded">
                  <% @record.guests.each do |guest| %>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-3">
                      <span><%= link_to guest.name, record_path(guest), class: "text-decoration-none" %></span>
                      <span class="badge bg-secondary rounded-pill">Guest</span>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                 <p class="text-muted mb-0">This record is neither a guest nor a host to other guests.</p>
              <% end %>
            </div>
            <%# End Host/Guest Display Section %>

          </div>
          <div class="mt-4 d-flex flex-wrap gap-2 align-items-center">
            <%# Always show the entry point to the flexible attendance form %>
            <%= link_to 'Record New Visit', new_visit_record_attendances_path(@record), class: 'btn btn-success rounded-pill shadow-sm' %>

            <%# Generate Pass button: Only visible if the last attendance is fully completed %>
            <% if @last_attendance_for_current_user.present? && @last_attendance_for_current_user.in_time.present? && @last_attendance_for_current_user.out_time.present? %>
              <%= link_to 'Generate Pass', print_pass_record_attendance_path(@record, @last_attendance_for_current_user, format: :pdf), class: 'btn btn-primary rounded-pill shadow-sm', target: '_blank', rel: 'noopener' %>
            <% end %>

            <%= link_to 'View History', history_record_attendances_path(@record, id: @last_attendance_for_current_user&.id), class: 'btn btn-info rounded-pill shadow-sm' %>
            <% if current_user&.role == 'admin' %>
              <%= button_to 'Destroy', record_path(@record), method: :delete,
                            class: 'btn btn-danger rounded-pill shadow-sm',
                            data: { turbo_confirm: 'Are you sure you want to delete this record?' } %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .list-group-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  .list-group-item:last-child {
    border-bottom: none;
  }
  .badge {
    font-size: 0.875rem;
  }
</style>